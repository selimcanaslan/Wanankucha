@page "/reset-password"
@using Wanankucha.Web.Services
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Reset Password - Wanankucha</PageTitle>

<div class="auth-container">
    <div class="auth-card">
        <h1>Reset Password</h1>
        <p class="auth-subtitle">Enter your new password below.</p>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">
                @successMessage
                <br /><br />
                <a href="/login" class="btn btn-primary">Go to Login</a>
            </div>
        }

        @if (!isSuccess)
        {
            @if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(email))
            {
                <div class="alert alert-warning">
                    Invalid or missing reset link. Please request a new password reset.
                    <br /><br />
                    <a href="/forgot-password">Request New Reset Link</a>
                </div>
            }
            else
            {
                <EditForm Model="model" OnValidSubmit="HandleSubmit" FormName="resetPassword">
                    <DataAnnotationsValidator />
                    
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <InputText id="email" @bind-Value="model.Email" class="form-control" readonly />
                    </div>
                    
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <InputText id="newPassword" @bind-Value="model.NewPassword" type="password" class="form-control" placeholder="Enter new password" />
                        <ValidationMessage For="@(() => model.NewPassword)" />
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <InputText id="confirmPassword" @bind-Value="model.ConfirmPassword" type="password" class="form-control" placeholder="Confirm new password" />
                        <ValidationMessage For="@(() => model.ConfirmPassword)" />
                    </div>

                    <button type="submit" class="btn btn-primary" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner"></span>
                            <span>Resetting...</span>
                        }
                        else
                        {
                            <span>Reset Password</span>
                        }
                    </button>
                </EditForm>
            }
        }
        
        <div class="auth-links">
            <a href="/login">Back to Login</a>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? Token { get; set; }
    
    [SupplyParameterFromQuery]
    public string? Email { get; set; }
    
    private string? token;
    private string? email;
    
    private ResetPasswordModel model = new();
    private string? errorMessage;
    private string? successMessage;
    private bool isLoading;
    private bool isSuccess;

    protected override void OnInitialized()
    {
        token = Token;
        email = Email;
        
        if (!string.IsNullOrEmpty(email))
        {
            model.Email = Uri.UnescapeDataString(email);
        }
        if (!string.IsNullOrEmpty(token))
        {
            model.Token = Uri.UnescapeDataString(token);
        }
    }

    private async Task HandleSubmit()
    {
        isLoading = true;
        errorMessage = null;
        successMessage = null;

        if (model.NewPassword != model.ConfirmPassword)
        {
            errorMessage = "Passwords do not match.";
            isLoading = false;
            return;
        }

        try
        {
            var result = await AuthService.ResetPasswordAsync(
                model.Email, 
                model.Token, 
                model.NewPassword, 
                model.ConfirmPassword);
            
            if (result.Succeeded)
            {
                successMessage = "Your password has been reset successfully. You can now log in with your new password.";
                isSuccess = true;
            }
            else
            {
                errorMessage = result.Message ?? "Failed to reset password. The link may have expired.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private class ResetPasswordModel
    {
        public string Email { get; set; } = string.Empty;
        public string Token { get; set; } = string.Empty;
        
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "New password is required")]
        [System.ComponentModel.DataAnnotations.MinLength(6, ErrorMessage = "Password must be at least 6 characters")]
        public string NewPassword { get; set; } = string.Empty;
        
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Please confirm your password")]
        [System.ComponentModel.DataAnnotations.Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
